export default class Dreamweaver{constructor(...t){DW_curtain.canvas=t[0],DW_brush.div=t[1],this.autoCreateTools(t[2]),DW_curtain.canvas&&(DW_curtain.ctx=DW_curtain.canvas.getContext("2d"),DW_curtain.size.width=DW_curtain.canvas.width,DW_curtain.size.height=DW_curtain.canvas.height,DW_curtain.canvas.onpointermove=function(t){mouseAxis.lastX=mouseAxis.nowX,mouseAxis.lastY=mouseAxis.nowY,mouseAxis.nowX=t.offsetX,mouseAxis.nowY=t.offsetY,drawPicture(mouseAxis,DW_curtain)},DW_curtain.canvas.onpointerdown=function(t){DW_curtain.draw=!0,mouseAxis.firstX=t.offsetX,mouseAxis.firstY=t.offsetY,DW_curtain.ctx.beginPath(),console.log(DW_curtain.history_current+1,DW_curtain.history.length-DW_curtain.history_current+1),DW_curtain.history.splice(DW_curtain.history_current+1,DW_curtain.history.length-DW_curtain.history_current-1)},DW_curtain.canvas.onpointerup=function(t){DW_curtain.draw=!1;let e=new Image;e.src=DW_curtain.canvas.toDataURL(),DW_curtain.history.push(e),DW_curtain.history_current++}),DW_brush.div&&(DW_brush.colorBar.canvas=DW_brush.div.querySelector("#colorBar"),DW_brush.colorBar.ctx=DW_brush.div.querySelector("#colorBar").getContext("2d"),DW_brush.colorBar.size.width=DW_brush.colorBar.canvas.width,DW_brush.colorBar.size.height=DW_brush.colorBar.canvas.height,DW_brush.colorBar.array=createColorArray(9),DW_brush.colorBar.canvas.onmousemove=function(t){mouseAxis.lastX=mouseAxis.nowX,mouseAxis.lastY=mouseAxis.nowY,mouseAxis.nowX=t.offsetX,mouseAxis.nowY=t.offsetY,colorBarDraw(mouseAxis,DW_brush,DW_curtain)},DW_brush.colorBar.canvas.onmousedown=function(t){DW_brush.colorBar.draw=!0,colorBarDraw(mouseAxis,DW_brush,DW_curtain)},DW_brush.colorBar.canvas.onmouseup=function(t){DW_brush.colorBar.draw=!1},DW_brush.div.querySelector("#painter").querySelectorAll("button").forEach((function(t){t.onclick=function(e){e.cancelBubble=!0,DW_curtain.shapeFun=chargeShapeFun(t.id,DW_curtain.ctx),t.style="background-color:#46a3ff; border:2px solid #000000;",DW_brush.div.querySelectorAll("button").forEach((function(e){e.id!==t.id&&(e.style="")}));const r='<svg xmlns="http://www.w3.org/2000/svg" fill="'+DW_brush.colorBar.ctx.fillStyle+'" width="24" height="24" viewBox="0 0 24 24"><path d="M7.127 22.564l-7.126 1.436 1.438-7.125 5.688 5.689zm-4.274-7.104l5.688 5.689 15.46-15.46-5.689-5.689-15.459 15.46z" /></svg>',n="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(r)));DW_curtain.canvas.style.cursor="url("+n+") 0 24,auto"}})),DW_brush.div.querySelector("#tool").querySelectorAll("button").forEach((function(t){t.onclick=function(e){featureFun(t.id,DW_curtain)}})),updateColorBar(DW_brush.colorBar.array,DW_brush.colorBar.ctx),updateColorSlider(0,DW_brush.colorBar),colorBarDraw(mouseAxis,DW_brush,DW_curtain))}setSize(t){DW_curtain.ctx.lineWidth=t}sendCanvas(){return DW_curtain.canvas}setCanvasSize(t=DW_curtain.canvas,e,r,n,o){t.canvas&&(t.canvas.style.left=n,t.size.width=t.canvas.width,t.size.height=t.canvas.height)}autoCreateTools(t=!1){if(0==t)return;let e=document.getElementById("painter");if(null==e.querySelector("#pen")){let t=document.createElement("button");t.id="pen",t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path d="M7.127 22.564l-7.126 1.436 1.438-7.125 5.688 5.689zm-4.274-7.104l5.688 5.689 15.46-15.46-5.689-5.689-15.459 15.46z" /></svg>',e.appendChild(t)}if(null==e.querySelector("#round")){let t=document.createElement("button");t.id="round",t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path d="M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12z" /></svg>',e.appendChild(t)}if(null==e.querySelector("#square")){let t=document.createElement("button");t.id="square",t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path d="M22 2v20h-20v-20h20zm2-2h-24v24h24v-24z" /></svg>',e.appendChild(t)}if(null==e.querySelector("#arrow")){let t=document.createElement("button");t.id="arrow",t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path d="m18.787 9.473s-4.505-4.502-6.259-6.255c-.147-.146-.339-.22-.53-.22-.192 0-.384.074-.531.22-1.753 1.753-6.256 6.252-6.256 6.252-.147.147-.219.339-.217.532.001.19.075.38.221.525.292.293.766.295 1.056.004l4.977-4.976v14.692c0 .414.336.75.75.75.413 0 .75-.336.75-.75v-14.692l4.978 4.978c.289.29.762.287 1.055-.006.145-.145.219-.335.221-.525.002-.192-.07-.384-.215-.529z" /></svg>',e.appendChild(t)}if(null==e.querySelector("#rubber")){let t=document.createElement("button");t.id="rubber",t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path d="M5.662 23l-5.369-5.365c-.195-.195-.293-.45-.293-.707 0-.256.098-.512.293-.707l14.929-14.928c.195-.194.451-.293.707-.293.255 0 .512.099.707.293l7.071 7.073c.196.195.293.451.293.708 0 .256-.097.511-.293.707l-11.216 11.219h5.514v2h-12.343zm3.657-2l-5.486-5.486-1.419 1.414 4.076 4.072h2.829zm.456-11.429l-4.528 4.528 5.658 5.659 4.527-4.53-5.657-5.657z" /></svg>',e.appendChild(t)}if(null==e.querySelector("#text")){let t=document.createElement("button");t.id="text",t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path d="M22 0h-20v6h1.999c0-1.174.397-3 2.001-3h4v16.874c0 1.174-.825 2.126-2 2.126h-1v2h9.999v-2h-.999c-1.174 0-2-.952-2-2.126v-16.874h4c1.649 0 2.02 1.826 2.02 3h1.98v-6z" /></svg>',e.appendChild(t)}let r=document.getElementById("tool");if(null==r.querySelector("#delete")){let t=document.createElement("button");t.id="delete",t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path d="M19 14.586l3.586-3.586 1.414 1.414-3.586 3.586 3.586 3.586-1.414 1.414-3.586-3.586-3.586 3.586-1.414-1.414 3.586-3.586-3.586-3.586 1.414-1.414 3.586 3.586zm-7 6.414h-12v-2h12v2zm0-4.024h-12v-2h12v2zm0-3.976h-12v-2h12v2zm12-4h-24v-2h24v2zm0-4h-24v-2h24v2z" /></svg>',r.appendChild(t)}if(null==r.querySelector("#save")){let t=document.createElement("button");t.id="save",t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path d="M14 3h2.997v5h-2.997v-5zm9 1v20h-22v-24h17.997l4.003 4zm-17 5h12v-7h-12v7zm14 4h-16v9h16v-9z" /></svg>',r.insertBefore(t,r.querySelector("#delete"))}if(null==r.querySelector("#redo")){let t=document.createElement("button");t.id="redo",t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path d="M4.115 5.515c4.617-4.618 12.056-4.676 16.756-.195l2.129-2.258v7.938h-7.484l2.066-2.191c-2.819-2.706-7.297-2.676-10.074.1-2.992 2.993-2.664 7.684.188 10.319l-3.314 3.5c-4.716-4.226-5.257-12.223-.267-17.213z" /></svg>',r.insertBefore(t,r.querySelector("#save"))}if(null==r.querySelector("#undo")){let t=document.createElement("button");t.id="undo",t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path d="M19.885 5.515c-4.617-4.618-12.056-4.676-16.756-.195l-2.129-2.258v7.938h7.484l-2.066-2.191c2.82-2.706 7.297-2.676 10.074.1 2.992 2.993 2.664 7.684-.188 10.319l3.314 3.5c4.716-4.226 5.257-12.223.267-17.213z" /></svg>',r.insertBefore(t,r.querySelector("#redo"))}if(null==r.querySelector("#close")){let t=document.createElement("button");t.id="close",t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-unlock"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></svg>',r.insertBefore(t,r.querySelector("#undo"))}if(null==r.querySelector("#open")){let t=document.createElement("button");t.id="open",t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-lock"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>',r.insertBefore(t,r.querySelector("#close"))}}}export const DW_curtain={canvas:null,ctx:null,draw:!1,shapeFun:function(){},size:{top:12,left:12,width:500,height:500},history:[],history_current:-1};export const DW_brush={div:null,text:null,colorBar:{canvas:null,ctx:null,draw:!1,size:{top:null,left:null,width:120,height:10},array:[]}};const mouseAxis={nowX:0,nowY:0,lastX:0,lastY:0,firstX:0,firstY:0};function createColorArray(t=15){let e=[],r=255/t*6,n=255,o=0,i=0;for(let s=0;s<=r;s++)e.push({r:n,g:o,b:i}),o<=0&&n>=255&&(i+=t),o<=0&&i>=255&&(n-=t),n<=0&&i>=255&&(o+=t),n<=0&&o>=255&&(i-=t),i<=0&&o>=255&&(n+=t),i<=0&&n>=255&&(o-=t);return e}function updateColorSlider(t,e){t-=8;const{ctx:r,array:n}=e;t<2?t=1:t>e.size.width-16&&(t=e.size.width-15),r.lineWidth=2,r.strokeStyle="rgba(0, 0, 0, 1)",r.beginPath(),r.arc(t+7,10,8,0,2*Math.PI),r.stroke(),r.strokeStyle="rgba(255, 255, 255, 1)",r.beginPath(),r.arc(t+7,10,7,0,2*Math.PI),r.stroke(),r.fillStyle="rgba("+n[t].r+","+n[t].g+" ,"+n[t].b+", 1)",r.beginPath(),r.arc(t-0+7,10,5,0,2*Math.PI),r.fill()}function updateColorBar(t,e){for(let r=0;r<t.length;r++)e.fillStyle="rgba("+t[r].r+","+t[r].g+" ,"+t[r].b+", 1)",e.beginPath(),e.moveTo(r+7,6),e.lineTo(7+ ++r,6),e.lineTo(r+7,14),e.lineTo(7+--r,14),e.fill()}function clear(t){t.ctx.clearRect(0,0,t.size.width,t.size.height)}export function colorBarDraw(t,e,r){const{colorBar:n}=e;if(!1===n.draw)return;clear(n),updateColorBar(n.array,n.ctx),updateColorSlider(t.nowX,n),r.ctx.fillStyle=n.ctx.fillStyle,r.ctx.strokeStyle=n.ctx.fillStyle;const o='<svg xmlns="http://www.w3.org/2000/svg" stroke-width="60" fill="'+DW_brush.colorBar.ctx.fillStyle+'" width="24" height="24" viewBox="0 0 24 24"><path d="M7.127 22.564l-7.126 1.436 1.438-7.125 5.688 5.689zm-4.274-7.104l5.688 5.689 15.46-15.46-5.689-5.689-15.459 15.46z" /></svg>',i="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(o)));DW_curtain.canvas.style.cursor="url("+i+") 0 24,auto"}function chargeShapeFun(t,e){switch(e.globalCompositeOperation="source-over",e.lineJoin="round",e.lineCap="round",t){case"pen":return function(t,e){e.lineTo(t.nowX,t.nowY),e.stroke()};case"square":return function(t,e,r){clearPicture(r),e.beginPath(),e.strokeRect(t.firstX,t.firstY,t.nowX-t.firstX,t.nowY-t.firstY),e.stroke()};case"round":return function(t,e,r){clearPicture(r),e.beginPath(),e.ellipse(t.firstX+(t.nowX-t.firstX)/2,t.firstY+(t.nowY-t.firstY)/2,Math.abs(t.nowX-t.firstX)/2,Math.abs(t.nowY-t.firstY)/2,Math.PI,0,2*Math.PI),e.stroke()};case"arrow":return function(t,e,r){if(clearPicture(r),0!==t.nowX&&0!==t.nowY&&0!==t.firstX&&0!==t.firstY){e.fill();var n=22,o=2,i=Math.atan2(t.nowY-t.firstY,t.nowX-t.firstX),s=Math.cos(i),a=Math.sin(i),l=-n*s-n/o*a,c=-n*s+n/o*a,u=-n*a+n/o*s,h=n*a+n/o*s,d=-(n=18)*s-n/(o=4)*a,w=-n*s+n/o*a,v=-n*a+n/o*s,g=n*a+n/o*s;e.beginPath(),e.moveTo(t.nowX,t.nowY),e.lineTo(t.nowX+l,t.nowY+u),e.lineTo(t.nowX+d,t.nowY+v),e.lineTo(t.firstX,t.firstY),e.lineTo(t.nowX+w,t.nowY-g),e.lineTo(t.nowX+c,t.nowY-h),e.closePath()}};case"rubber":return function(t,e){e.globalCompositeOperation="destination-out",e.moveTo(t.lastX,t.lastY),e.lineTo(t.nowX,t.nowY),e.stroke()};case"text":if(null==DW_brush.text){DW_brush.text=document.createElement("div"),DW_brush.text.setAttribute("id","text"),DW_brush.text.style="\n          background-color:rgba(0.5,0.5,0.5,0);\n          position: fixed;\n          left:500px;\n          top:500px;\n          display:none";let t=document.createElement("textarea");t.setAttribute("id","text_input"),t.style="background-color:rgba(0.5,0.5,0.5,0.5)";let r=document.createElement("button");r.setAttribute("id","access_btn"),r.innerHTML="Access",r.style="color:rgba(0.5,0.5,0.5,0.5)",r.onclick=function(t){e.fillText(DW_brush.text.querySelector("#text_input").value,Number(DW_brush.text.style.left.replace("px",""))-Number(DW_curtain.canvas.style.left.replace("px","")),Number(DW_brush.text.style.top.replace("px",""))-20)};let n=document.createElement("button");n.setAttribute("id","access_btn"),n.innerHTML="Cancel",n.style="color:rgba(0.5,0.5,0.5,0.5)",n.onclick=function(){DW_brush.text.style.display="none"},DW_brush.text.appendChild(r),DW_brush.text.appendChild(n),DW_brush.text.appendChild(document.createElement("br")),DW_brush.text.appendChild(t),DW_curtain.canvas.parentNode.appendChild(DW_brush.text)}return function(t,e){DW_brush.text.style.display="block",DW_brush.text.style.color=e.fillStyle,DW_brush.text.style.left=10+t.nowX+Number(DW_curtain.canvas.style.left.replace("px",""))+"px",DW_brush.text.style.top=-50+t.nowY+Number(DW_curtain.canvas.style.top.replace("px",""))+"px"}}}export function featureFun(t,e){const{ctx:r,history:n}=e;switch(r.globalCompositeOperation="source-over",t){case"undo":clear(e),e.history_current>=0&&(e.history_current--,e.history_current>=0&&r.drawImage(n[e.history_current],0,0));break;case"redo":e.history_current<n.length-1&&(e.history_current++,clear(e),r.drawImage(n[e.history_current],0,0));break;case"save":let t=new Image;return t.src=e.canvas.toDataURL(),t;case"delete":clear(e),n.length=0,e.history_current=-1}}function drawPicture(t,e){const{ctx:r}=e;!1!==e.draw&&e.shapeFun(t,r,e)}function clearPicture(t){const{ctx:e,history:r,history_current:n}=t;clear(t),n>=0&&e.drawImage(r[n],0,0)}